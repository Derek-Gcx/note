# L0: Amgame 实验报告
高辰潇
人工智能学院
181220014

## 实现游戏：dino
+ 游戏类似chrome的小恐龙游戏dino，是一款像素风格的横版闯关益智策略游戏。
<img src="img/2020-02-24-16-53-53.png" width="300" />
+ 目前实现的逻辑还比较简单，主要的玩法是
  + 有四张地图，每张地图上有若干障碍物，小恐龙若撞击到障碍物就会死亡，从当前地图的左侧重新开始游戏
  + 玩家可以控制小恐龙进行跳跃，按下"$\uparrow$"可进行短跳，按下"x"可进行长跳
  + 通过当前地图后，自动切换到下一张地图
  + 按下"Esc"键退出游戏

## 代码设计
```bash
include
├── game.h     # 包含游戏中的结构体、函数声明、am的API和一些调试宏
└── map.h      # 包含游戏的地图、物体的像素信息的声明
src
├── avatar.c   # 小恐龙相关的函数
├── game.c     # 游戏主循环
├── logic.c    # 处理物体间的交互逻辑（主要是小恐龙和障碍物的碰撞）
└── video.c    # 图像绘制函数以及像素信息
```
### 游戏主循环
+ 篇幅有限，不展开介绍。主循环的逻辑为：碰撞检测---绘制图像---更新位置---响应键盘---等待下一帧。具体请见`game.c`。
### 图像绘制
+ 在绘制图像时我是将小恐龙、障碍物和背景分开绘制的，因此在每一帧更新时只需要更新小恐龙即可。
+ 在`video.c`文件中可以看到，小恐龙、障碍物的图案和障碍物位置都是“静态编码”在文件中的。
+ 在更新画面时遇到了一个问题，即原来的图像仍会保留在原处不会消失。因此在每次重新绘制小恐龙前，我都在旧的位置绘制一个黑色方块，这样就将旧的图像给遮盖住了。同理，在进入下一张关卡时，也在所有图像处画上黑色，然后绘制新的关卡。
+ 后来发现小恐龙总是用一张静态的图像实在是缺乏动感，因此我又绘制了“蹬腿”的动作，并在`draw_avatar`函数中维护一个计数器，每10帧切换一次左右腿。

### 不同分辨率下的处理
+ 在调试该游戏时我始终是在native上运行的，画面分辨率为`400*300`，然而x86平台下画面分辨率为`640*480`，因此需要对多分辨率情况进行特殊处理。
+ 我最初的想法是将画面上出现的物体的大小随着分辨率的变化而等比例缩放，然而这样做的问题在于，`abstract-machine`中没有实现`malloc`函数，无法根据从端口读取到的长宽信息动态定义`pixel`数组的大小。除此以外，由于这里小恐龙的绘制使用的是“不规则的图案”，因此在非整数倍缩放时小恐龙的大小会失真。综上所述，最后并未采用这一方法。
+ 作为替代，我的实现是在新的画面中央裁剪出一片`400*300`的分辨率区域显示图像，画面中物体的大小均为固定的像素大小。这可以通过画面绘制时的整体偏移来实现。
